
close all;
clc;
clear all;

%% Fundamental Quantities
degrees = pi/180;
centimeters = 1;
millimeters = 0.1*centimeters;
meters = 100*centimeters;
seconds = 1;
minutes = 60*seconds;
c0 = 299792458*meters/seconds;
hertz = 1/seconds;
gigahertz = 1e9*hertz;
e0 = 8.854*10^-12;
pi = 3.141592653589793238462643383279502884197169399375105820974944592307816406286;


%% Parameters

% abs_S11 = [0.856 0.456];
% arg_S11 = [163.2 150.4]*degrees;
% 
% abs_S21 = [0.609 0.345];
% arg_S21 = [-140.5 168.3]*degrees;

f0 = 15*gigahertz;
bw = 29*gigahertz;
nvalues = 200;
freq_range = [f0-bw/2:(f0+bw/2-(f0-bw/2))/(nvalues-1):f0+bw/2];
d = 0.3*centimeters;
fc = 0*gigahertz;

lambda0 = c0/f0;
lambdac = c0./fc;
lambda_range = c0./freq_range;
%% S11 Data Xpol
% S11 = [-0.010628267813546161-0.04601049669130688*1i
%         -0.02554635997506463-0.07027415687875586*1i
%         -0.04653451596260765-0.09102311341305203*1i
%         -0.07286220742099557-0.10712083271706205*1i
%         -0.10360770277564751-0.11757430730442123*1i
%         -0.13768566419163678-0.12156450681106223*1i
%         -0.17387943339132045-0.11847154663847537*1i
%         -0.21087696457121088-0.10789385360388638*1i
%         -0.24730926800184114-0.08966084338229337*1i
%         -0.2817901789002094-0.06383884818919561*1i
%         -0.31295626069741556-0.030730253650482264*1i
%         -0.33950568751840277+0.009133985178008638*1i
%         -0.3602350230099702+0.055008084221342464*1i
%         -0.37407291658152436+0.1059508907592672*1i
%         -0.38010986736025437+0.16085038225583748*1i
%         -0.3776233540801124+0.21845240699869697*1i
%         -0.36609778915190455+0.27739278610867774*1i
%         -0.3452389208922135+0.3362318440789539*1i
%         -0.31498247349692476+0.3934904128445023*1i
%         -0.27549697472530943+0.44768636040512033*1i
%         -0.22718087207223842+0.4973707264204491*1i
%         -0.1706541759873375+0.5411626006205703*1i
%         -0.10674499085999367+0.5777819518129197*1i
%         -0.03647139920406714+0.606079701977632*1i
%         0.03898074932860886+0.6250644377845047*1i
%         0.1182835252024222+0.633925257312015*1i
%         0.19999541516427338+0.6320503595608483*1i
%         0.28259192968249186+0.6190410954707535*1i
%         0.36449761098187244+0.5947213089856751*1i
%         0.44411873386216044+0.5591419028766866*1i
%         0.5198760088272304+0.5125806646232605*1i
%         0.5902366271169975+0.4555374810130915*1i
%         0.6537450283578543+0.38872515503555394*1i
%         0.7090518218802008+0.31305611415510465*1i
%         0.754940350522287+0.22962536456690694*1i
%         0.7903504492492257+0.13969010121482262*1i
%         0.8143990184777461+0.04464642813900868*1i
%         0.8263971021480582-0.05399632174267614*1i
%         0.8258632319444771-0.15464315369596102*1i
%         0.8125328704330947-0.25564233616036475*1i
%         0.7863638562507405-0.35531514842275014*1i
%         0.7475378229918699-0.4519859176382854*1i
%         0.6964576294003324-0.5440118213293839*1i
%         0.6337409013478654-0.6298119479107881*1i
%         0.5602098454248174-0.7078951305615091*1i
%         0.4768775494161803-0.776886098372324*1i
%         0.384931036093204-0.8355495227021655*1i
%         0.28571138314362-0.8828115755475967*1i
%         0.18069126322302723-0.9177786596292786*1i
%         0.07145029441884716-0.9397530155193958*1i
%         -0.040351375177456114-0.9482449595442748*1i
%         -0.1530007941770559-0.9429815613582039*1i
%         -0.26476077008187576-0.9239116345989897*1i
%         -0.37389878606237564-0.8912069783267668*1i
%         -0.47871579252598623-0.8452598619713302*1i
%         -0.5775743917963009-0.7866768016202342*1i
%         -0.6689259379768409-0.7162687389710437*1i
%         -0.7513360913570994-0.6350377997470619*1i
%         -0.8235083951555615-0.5441608690979541*1i
%         -0.8843054784147212-0.4449702766650752*1i
%         -0.932767531617666-0.3389319339521063*1i
%         -0.968127750986793-0.22762131070044583*1i
%         -0.9898245028631317-0.11269767390670886*1i
%         -0.9975100199659589+0.004122958208024196*1i
%         -0.9910555052880204+0.1210956754109845*1i
%         -0.9705525853205921+0.23647486608870585*1i
%         -0.9363111205545817+0.34854225747777845*1i
%         -0.8888534460997566+0.4556343333338402*1i
%         -0.828905177193415+0.5561686757565651*1i
%         -0.7573827718746746+0.6486688051951935*1i
%         -0.6753780949311062+0.7317871273378729*1i
%         -0.5841402724134435+0.8043256363520618*1i
%         -0.4850551638928394+0.86525406939919*1i
%         -0.37962280988606506+0.9137252560183486*1i
%         -0.2694332344892539+0.949087456443068*1i
%         -0.15614099855355293+0.970893533858036*1i
%         -0.0414389072590423+0.9789068558910885*1i
%         0.07296872153674668+0.9731038693722476*1i
%         0.18539282441686747+0.9536733389646557*1i
%         0.2941859980813858+0.9210122843535828*1i
%         0.3977681568939158+0.8757186922297909*1i
%         0.49465106849525853+0.8185811185272521*1i
%         0.5834614086946178+0.7505653336806027*1i
%         0.6629619937498141+0.6727981995742088*1i
%         0.7320708669419667+0.5865490019302658*1i
%         0.7898779373715027+0.4932084966205837*1i
%         0.8356588927318026+0.3942659631252785*1i
%         0.8688861352651651+0.2912845931896157*1i
%         0.8892365221214711+0.18587557739414257*1i
%         0.896595728902315+0.07967128622236609*1i
%         0.8910590991716825-0.025702025772129034*1i
%         0.8729288938062648-0.12865153538081295*1i
%         0.84270791253579-0.22764470481610805*1i
%         0.8010895256788356-0.3212351770843356*1i
%         0.7489442261019277-0.4080872081803477*1i
%         0.6873028883340139-0.48699813591988117*1i
%         0.6173370013459418-0.5569184026795285*1i
%         0.5403362207948381-0.6169686810389468*1i
%         0.4576836616629717-0.6664536972179785*1i
%         0.37082941765564387-0.7048724045410822*1i]';
% %% S21 Data Xpol
% S21 = [0.9754074622888236-0.21269967136448567*1i
%         0.9394465630098008-0.3327588381053*1i
%         0.8881397811152687-0.4467908845467758*1i
%         0.822505714505584-0.5527647782235832*1i
%         0.743839938664449-0.6488248541099584*1i
%         0.6536840477548209-0.7333294186899879*1i
%         0.553789243649268-0.8048837454366051*1i
%         0.44607553959030594-0.8623666716772458*1i
%         0.33258774581595046-0.904950242234366*1i
%         0.21544946013711508-0.9321120694018626*1i
%         0.09681629924618947-0.9436403005407908*1i
%         -0.021170421309266958-0.939631297806155*1i
%         -0.13642841468437347-0.9204803323821835*1i
%         -0.246976509665402-0.8868657724211486*1i
%         -0.35097316996935235-0.8397273951619197*1i
%         -0.4467506592969403-0.7802395765785813*1i
%         -0.5328442188791126-0.7097802048735785*1i
%         -0.6080157845115273-0.6298962270001199*1i
%         -0.6712719316855628-0.5422667711157698*1i
%         -0.7218758955217315-0.4486647942061974*1i
%         -0.7593536626262345-0.3509181855544965*1i
%         -0.7834942713478786-0.25087121625177505*1i
%         -0.794344582635508-0.15034716567521203*1i
%         -0.7921988938709706-0.051112881179472575*1i
%         -0.7775838614702677+0.045154059556908835*1i
%         -0.7512392740562885+0.13689500979016214*1i
%         -0.7140952764408042+0.22269626643837204*1i
%         -0.6672466858295362+0.30131106675894165*1i
%         -0.6119250661513057+0.3716773066052152*1i
%         -0.549469235205643+0.4329308211860582*1i
%         -0.48129487349606725+0.48441416873776805*1i
%         -0.4088638846127592+0.5256809513953322*1i
%         -0.3336541262479989+0.556495794413732*1i
%         -0.2571300900135922+0.5768301835392279*1i
%         -0.18071505881650826+0.5868544298937979*1i
%         -0.10576521427133743+0.5869260915904306*1i
%         -0.03354610517814617+0.5775752310982617*1i
%         0.03478817698660593+0.5594869270138025*1i
%         0.09821283681744412+0.5334814884703815*1i
%         0.15584701714876872+0.5004928402525273*1i
%         0.2069651012663492+0.4615455572376239*1i
%         0.2510045976489535+0.417731028635217*1i
%         0.2875705930846258+0.3701832263476188*1i
%         0.3164368201122719+0.3200545383333212*1i
%         0.33754344097092975+0.2684921078792292*1i
%         0.35099170210648195+0.21661509391409686*1i
%         0.3570356603696252+0.1654932366433772*1i
%         0.35607122398953994+0.116127077658857*1i
%         0.34862278804399754+0.0694301452026752*1i
%         0.33532777598203206+0.026213374423506353*1i
%         0.3169194268850066-0.012828011089538604*1i
%         0.2942081917799295-0.047124978671314356*1i
%         0.26806211658700574-0.07624240184492073*1i
%         0.23938659308068508-0.09988393636326805*1i
%         0.20910386070503897-0.1178940262038128*1i
%         0.17813264396982925-0.13025705526890868*1i
%         0.14736830515488364-0.13709371190924133*1i
%         0.11766387717295405-0.13865468372149675*1i
%         0.08981231965065337-0.13531184607961513*1i
%         0.06453031464399078-0.12754714993504013*1i
%         0.04244388705853268-0.11593945287384255*1i
%         0.024076098775051128-0.10114957164768373*1i
%         0.009837025139026843-0.08390386358673435*1i
%         1.6178581623862174E-5-0.06497666772557813*1i
%         -0.005222502383792515-0.045171953622154544*1i
%         -0.00584302871907447-0.02530453637403436*1i
%         -0.0019370796823366847-0.006181220111065628*1i
%         0.006278908028120195+0.011417770686562969*1i
%         0.018469206833563998+0.026756722073728697*1i
%         0.034186702001513816+0.03916138915220071*1i
%         0.05288307258766728+0.04803466846430843*1i
%         0.07392105200443971+0.05287069607750155*1i
%         0.0965885372346727+0.0532671126848393*1i
%         0.1201142868205762+0.04893526971092264*1i
%         0.14368492347205492+0.039708185468559594*1i
%         0.1664629373777706+0.025546097158544983*1i
%         0.18760537087923798+0.006539492370549694*1i
%         0.20628285380096045-0.017090457707613964*1i
%         0.22169865112119014-0.04499410220301417*1i
%         0.23310738055014596-0.07669815116756996*1i
%         0.2398330567617966-0.1116131128885375*1i
%         0.24128612146086312-0.14904324790120027*1i
%         0.23697912426882164-0.1881989191043838*1i
%         0.22654072890359916-0.22821117603942118*1i
%         0.20972773280851575-0.2681483692574148*1i
%         0.1864348069411667-0.3070345478917364*1i
%         0.1567016866664685-0.3438693504344288*1i
%         0.12071757546732265-0.37764905595263587*1i
%         0.07882256131136728-0.40738842159457445*1i
%         0.031505891653200724-0.43214289359980956*1i
%         -0.020598992404734985-0.45103074487218425*1i
%         -0.0767226d9934082915-0.4632546645059632*1i
%         -0.13597137360606162-0.46812230567799173*1i
%         -0.19734131347227463-0.4650652902722909*1i
%         -0.2597365262635717-0.45365617360977123*1i
%         -0.32198894213137785-0.43362289247811114*1i
%         -0.3828809235215902-0.40486025548069715*1i
%         -0.44116962799077203-0.36743808681661977*1i
%         -0.49561271153590797-0.32160570179672343*1i
%         -0.5449948040028894-0.2677924706450547*1i]';

%% S11 and S21 Data Ypol
S11 = [-0.010684328992656086-0.04623079568239312*1i
            -0.017340209457349105-0.06049808565552398*1i
            -0.025738975618079328-0.07314039645408285*1i
            -0.03559486420362602-0.08410144548802835*1i
            -0.04665600764232176-0.09341218956475417*1i
            -0.058735152899608664-0.10117026916896953*1i
            -0.07173009324845547-0.10750856096460475*1i
            -0.08563027242568015-0.11255804090882775*1i
            -0.10050867764301381-0.11641096029309012*1i
            -0.11650063610800715-0.11908983733472063*1i
            -0.13377292333503252-0.12052637585786882*1i
            -0.1524875124943246-0.12055268099198516*1i
            -0.17276448131345262-0.11890547189009505*1i
            -0.19340659363561863-0.11537387590933859*1i
            -0.2129884586124037-0.1095720798751859*1i
            -0.23183409795759544-0.1014672197777407*1i
            -0.24979367563231172-0.09122398236665342*1i
            -0.2667770845589283-0.07901976140221426*1i
            -0.2827565459994757-0.06502284283973692*1i
            -0.2977609986104743-0.049369588963019115*1i
            -0.31186192070136853-0.032143909908862525*1i
            -0.3251516452642873-0.013362374807822078*1i
            -0.33771659046508923+0.007032271188550047*1i
            -0.3496088291380356+0.02916756531250175*1i
            -0.36081983851571103+0.05322761782753432*1i
            -0.37109976353103724+0.0793674575721225*1i
            -0.37841821569421596+0.10654170553354164*1i
            -0.3831452419385928+0.13441483075202781*1i
            -0.3853149359038819+0.1627932650551676*1i
            -0.38499228749853787+0.19151302149421603*1i
            -0.38226300231545707+0.2204485284823652*1i
            -0.37722023780469466+0.2495182550890449*1i
            -0.36994931082349697+0.2786859788885355*1i
            -0.360511877081865+0.3079569283216375*1i
            -0.34893137438234123+0.33736859138521846*1i
            -0.3351815845649212+0.36697665078482805*1i
            -0.31917996594285475+0.39683718124880063*1i
            -0.3007869488884829+0.42698681574867875*1i
            -0.2796498513325301+0.4556336805557602*1i
            -0.256047536422922+0.48223670404837454*1i
            -0.23020300324659732+0.5073076527852811*1i
            -0.20219634080281498+0.5308424587973074*1i
            -0.172070099421081+0.5528503446190504*1i
            -0.13982468692772507+0.573340021323183*1i
            -0.10545722772405515+0.5921564622477348*1i
            -0.06940887597486174+0.6085148553592228*1i
            -0.03189003529265388+0.6223297242249315*1i
            0.007029761456500802+0.6336287463548537*1i
            0.04732035331226006+0.6424323440489308*1i
            0.08898826983217295+0.6487395515548029*1i
            0.13204645759780903+0.6524753303974722*1i
            0.17578624096036724+0.6531123938093897*1i
            0.21980460601266577+0.6505700422994684*1i
            0.26405670408681603+0.6448988805387524*1i
            0.30853053612716047+0.6361219218327341*1i
            0.3532373930321793+0.6242227113760237*1i
            0.39819911841741346+0.6091333768906986*1i
            0.4427187670223487+0.5906497296762918*1i
            0.48606213296031586+0.5688720872503056*1i
            0.5282182363857526+0.5438552438069464*1i
            0.5691932546920838+0.5156078885590628*1i
            0.6089945896106821+0.4840855134942528*1i
            0.6476122745392204+0.44918819889289735*1i
            0.6845552403313395+0.41089539248109747*1i
            0.7188139376578377+0.3697732172586351*1i
            0.7503712539200268+0.32589326505952787*1i
            0.7792346529268351+0.27922507020974513*1i
            0.8053789918003323+0.229678815976035*1i
            0.8287240601946397+0.17711358213283876*1i
            0.8487106046681869+0.12188608397958638*1i
            0.8647252757276102+0.06472677423238143*1i
            0.8768188929097558+0.00543125664053271*1i
            0.8847959480615292-0.05603178845003499*1i
            0.8882276245117593-0.11893188993359267*1i
            0.886932168041227-0.18321263525900558*1i
            0.880643531595071-0.24893827363040524*1i
            0.869063458261182-0.3151997001717491*1i
            0.8519560968885908-0.38179324696377354*1i
            0.8289155131319818-0.448770599343388*1i
            0.7998201781188712-0.5150612456729629*1i
            0.7644513354486239-0.5802056418376388*1i
            0.7221994152057907-0.6441289376781871*1i
            0.6731457534754858-0.705609231130146*1i
            0.6172840781978487-0.7638092988960211*1i
            0.5538029968227554-0.8183109167226037*1i
            0.48299855453821194-0.8676911107351075*1i
            0.40550510938659234-0.9106993583749542*1i
            0.32049272757125596-0.9462487604696095*1i
            0.22865177365792413-0.9725595649060564*1i
            0.13192961285549143-0.9882928438268342*1i
            0.030098574075608193-0.9914178644013973*1i
            -0.07507903772822536-0.9797888449883919*1i
            -0.17970744255026871-0.9531721430519915*1i
            -0.28220162708235635-0.9091103893998316*1i
            -0.37873732023472406-0.8460901591888017*1i
            -0.46407123872938993-0.7675806981403701*1i
            -0.534407352448945-0.6730528252484593*1i
            -0.5844899899621329-0.5642748882966093*1i
            -0.6122445575493434-0.4503846424351114*1i
            -0.6150817165228377-0.3348487022275588*1i
            -0.5907403224487803-0.22322264799135547*1i
            -0.5461569041157303-0.12513214791449034*1i
            -0.48379805955054705-0.04402183866732864*1i
            -0.4060882159229271+0.016255124776470484*1i
            -0.32490177985093466+0.05447210343313286*1i
            -0.24410609708920847+0.07182323957223323*1i
            -0.16399102831277634+0.06786553382811901*1i
            -0.09249272533347115+0.047174040608166684*1i
            -0.036640071812792704+0.017240528734148466*1i
            0.006611115410837096-0.019128546891957296*1i
            0.03913553164517565-0.061514867614816955*1i
            0.061011680397422885-0.11010428943037034*1i
            0.07132515161339166-0.1641435142071464*1i
            0.07258178854585436-0.2144477137967253*1i
            0.06435231263454161-0.2591508276693097*1i
            0.04904814050950693-0.2988993857401476*1i
            0.02783665003751927-0.3348798401913574*1i
            7.989874516816809E-4-0.3680714679080642*1i
            -0.03261454773432948-0.3988058560259246*1i
            -0.06888861125143175-0.4239335144384788*1i
            -0.1067421623691041-0.4422148736838053*1i
            -0.14585530204398822-0.4547718808208768*1i
            -0.18599886207892227-0.4625201713840566*1i
            -0.22735703306457158-0.466158471157016*1i
            -0.2703614708714287-0.4660366871758598*1i
            -0.3136879120622386-0.4615484951657568*1i
            -0.3551482662841425-0.45218544039183717*1i
            -0.39505010192143686-0.43865122038015925*1i
            -0.43348135691550566-0.421432941803303*1i
            -0.47065472366964994-0.4008719275572634*1i
            -0.5068428738736428-0.37713559108544037*1i
            -0.5417703394199292-0.3502236545706054*1i
            -0.5736874817127506-0.32045609418264176*1i
            -0.602790111972328-0.2882312307069418*1i
            -0.6292339577438271-0.253789226753137*1i
            -0.6531963089414913-0.2172773076119318*1i
            -0.6748452973861436-0.17875069540698377*1i
            -0.6942140069472662-0.13822175930310768*1i
            -0.7103068347400197-0.0964131034456431*1i
            -0.7231621209573859-0.05370906996502469*1i
            -0.7329331712522588-0.010218396289258282*1i
            -0.7397568490620788+0.03400629214894988*1i
            -0.7437383865861085+0.07895958531391102*1i
            -0.7449395145161464+0.12467038147207771*1i
            -0.7429946896525763+0.17047474727320222*1i
            -0.7379280453479468+0.21581577233458685*1i
            -0.7298791360616883+0.2606631559753484*1i
            -0.7189522394614576+0.3050130670859403*1i
            -0.7052151359737028+0.34888117218254344*1i
            -0.6886957989123501+0.3922907501409891*1i
            -0.6693745839326873+0.4348613007142048*1i
            -0.6474365955680943+0.47587952528126704*1i
            -0.6230124175979649+0.5153512387193651*1i
            -0.5961804125239943+0.5533008246315769*1i
            -0.5669850065646241+0.5897537609876531*1i
            -0.5354383564134392+0.6247268784265303*1i
            -0.5015963029953359+0.6580534256221952*1i
            -0.46589827228010844+0.68908830374951*1i
            -0.4284923833991241+0.7178154375271162*1i
            -0.38943447732961634+0.7442770822082712*1i
            -0.3487525843060554+0.768504126646055*1i
            -0.3064515843760375+0.79050890567139*1i
            -0.26256277690723423+0.8102358993188447*1i
            -0.21767814184984488+0.8272659531146701*1i
            -0.1720334383645847+0.8415620743707338*1i
            -0.12566317474606678+0.8531776643857291*1i
            -0.0785819885634163+0.8621466655385361*1i
            -0.030790986326783315+0.8684790411870335*1i
            0.017708952232238798+0.8721541043417987*1i
            0.06635355161754229+0.873013234295879*1i
            0.11475539238639641+0.8710626522479634*1i
            0.1629008874110637+0.8663612085932477*1i
            0.21078758583069332+0.8589437663796138*1i
            0.25841714104350183+0.8488192865791174*1i
            0.30578799832709486+0.835970723508118*1i
            0.35251915255471794+0.8204158907181452*1i
            0.3980637728612795+0.8023078226792727*1i
            0.4424241664802758+0.7817086635199298*1i
            0.4856093757489038+0.7586518367672546*1i
            0.5276238692241921+0.73314580909491*1i
            0.5684609109809142+0.7051762812100141*1i
            0.6079158901911154+0.674811942791082*1i
            0.6454241353983782+0.6424207851681993*1i
            0.6809711448927291+0.6080854381797385*1i
            0.7145766366619749+0.571835356529554*1i
            0.7462483089553222+0.5336783206746789*1i
            0.7759764289862321+0.49360447722445433*1i
            0.8036687988384228+0.4516610182559449*1i
            0.8288934361204706+0.4083878376156409*1i
            0.8516089173615154+0.36393770945194337*1i
            0.8718444505691373+0.31833356743325*1i
            0.8896114122766658+0.2715817540750224*1i
            0.9048995447636532+0.2236774013764212*1i
            0.9176649735274174+0.17463235173389074*1i
            0.9276889574849064+0.12502968255774335*1i
            0.9349396852767838+0.07515260160993198*1i
            0.9394542274663538+0.02501499723759044*1i
            0.941247925713372-0.025379528119880444*1i
            0.9403124382386019-0.07603148965311936*1i
            0.9366153221951301-0.1269390333990794*1i]';
    
S21 = [0.975351401207895-0.21291996993793094*1i
            0.9585451539846828-0.275427290597673*1i
            0.938053694695463-0.33554211872410156*1i
            0.9140876177383126-0.39324052525356185*1i
            0.8868164827455821-0.44852601946027043*1i
            0.8563645615091887-0.5014158679926389*1i
            0.8228105334885982-0.5519267900073023*1i
            0.7861911664345018-0.6000611809958822*1i
            0.7465086684891585-0.6457949821882203*1i
            0.7037410764189378-0.6890681660644558*1i
            0.6578547873171632-0.7297785676237718*1i
            0.6088181758771326-0.7677794834993671*1i
            0.5566151818783692-0.8028811223668167*1i
            0.5015235539011994-0.8344732871433418*1i
            0.44547287855593254-0.8617390479263132*1i
            0.38894162695792445-0.8848882968995796*1i
            0.3320415915009061-0.9040635325544616*1i
            0.2748425359729568-0.9193828840969036*1i
            0.2173827626488087-0.9309303746803624*1i
            0.15968183378590542-0.9387495659204869*1i
            0.1017543879098284-0.9428410370813184*1i
            0.043623910779178446-0.9431638116462685*1i
            -0.014664646728589647-0.9396404983902633*1i
            -0.0730343726362635-0.9321656017136798*1i
            -0.1313687623343968-0.9206162097707861*1i
            -0.18947310304488135-0.9048140542343024*1i
            -0.2456987016375762-0.8850512691174824*1i
            -0.2992754951008533-0.8623535354898199*1i
            -0.3502464982058717-0.8369009173359485*1i
            -0.39866463182734-0.8088247054957133*1i
            -0.4445782518236516-0.7782090614856725*1i
            -0.4880179004120787-0.7450965382274353*1i
            -0.5289853186027377-0.7094969343231168*1i
            -0.5674455374500662-0.6713986575383297*1i
            -0.6033225699067118-0.6307815802170041*1i
            -0.6364988889614688-0.5876302833084848*1i
            -0.6668185403682654-0.5419466114486293*1i
            -0.6940934367889705-0.49376058988941457*1i
            -0.7176396645684586-0.44476382790034513*1i
            -0.7375211268283136-0.39569410233914054*1i
            -0.7539776783824974-0.34612148322952474*1i
            -0.7670166643691394-0.29605613479488146*1i
            -0.7766025499808865-0.2455147003156487*1i
            -0.7826622561012788-0.19453374675817803*1i
            -0.7850936495325973-0.14330222425995504*1i
            -0.7841763715960072-0.0928304405592437*1i
            -0.7800662727639868-0.04330992055517346*1i
            -0.7727637356056071+0.005262204956593749*1i
            -0.762231165597187+0.05286096628834662*1i
            -0.748404917295882+0.09942323233347745*1i
            -0.7311995735072223+0.14481346148777993*1i
            -0.711201304493473+0.1882871265838276*1i
            -0.6888335121704097+0.22959729238012497*1i
            -0.6640710685971254+0.26875290741093744*1i
            -0.6368657725330595+0.30571237827695713*1i
            -0.607164712998033+0.3403796301156673*1i
            -0.5749207685739278+0.3726032457817236*1i
            -0.5406782433220475+0.4019804013013246*1i
            -0.5053699690006155+0.42843966861817184*1i
            -0.4689231408377218+0.45197445998862207*1i
            -0.43127137766345625+0.472503681471817*1i
            -0.3923794634578913+0.48987927741477005*1i
            -0.35226374090129786+0.5039009179352719*1i
            -0.3112522390981644+0.514322807892503*1i
            -0.2707190210325159+0.5216650149449266*1i
            -0.23062595729682864+0.5259283414544415*1i
            -0.19088628372283817+0.5269467197253406*1i
            -0.15150748497097127+0.52448175690811*1i
            -0.11261048175671505+0.5182613025684183*1i
            -0.07480579237775327+0.5085214727753143*1i
            -0.03881753342834414+0.495979349581992*1i
            -0.004593551341017689+0.4802675090235761*1i
            0.027648895299029322+0.461156588792902*1i
            0.05733814280518459+0.4394702194035926*1i
            0.0842781032714606+0.41508709295723406*1i
            0.10816588619424715+0.38766761272484507*1i
            0.1285560908216796+0.3583281226814352*1i
            0.14517704981845786+0.3271167269984571*1i
            0.15755784025953018+0.2935812340049095*1i
            0.16545160945248488+0.25911297423085555*1i
            0.1685753115416085+0.22411768155769865*1i
            0.16620047097507964+0.18808147965214198*1i
            0.1583551944424254+0.15260569224018464*1i
            0.1449253454039904+0.11873463262915979*1i
            0.12487858106741101+0.086037464737354*1i
            0.09860512933179105+0.05622559877046484*1i
            0.06659629046463149+0.031281217371757236*1i
            0.02766012633936158+0.011064590769305216*1i
            -0.017387111677908428-0.002557408990819786*1i
            -0.06646778409258573-0.006798608585208317*1i
            -0.12046581785506712-0.0013015426611285557*1i
            -0.17778582214087912+0.015930837071863237*1i
            -0.23346757386949207+0.047252850800363504*1i
            -0.2871912741486761+0.09314903691652064*1i
            -0.3359986513219779+0.1547804745810424*1i
            -0.37189583576293445+0.2309789512593126*1i
            -0.3932328099197383+0.32042420522525034*1i
            -0.3966500987871156+0.4212813859072144*1i
            -0.3754346631135225+0.5255403036583532*1i
            -0.3298980430984924+0.6287178526248376*1i
            -0.26037217843080235+0.7263206332162118*1i
            -0.1686042313317063+0.8073225142589132*1i
            -0.05987426628355466+0.8685402902343154*1i
            0.061199518137796054+0.9085540017698854*1i
            0.18633025244037538+0.9226397375162284*1i
            0.309890367036056+0.9130146993544874*1i
            0.4297456313754866+0.8826960229461089*1i
            0.5393759595508121+0.833396371652026*1i
            0.6335434818480589+0.7700935576810256*1i
            0.7130280210088313+0.6969620765088861*1i
            0.7793150955076594+0.6168315272617424*1i
            0.8339144927968775+0.5313794159904078*1i
            0.8778177545163844+0.44157686265606455*1i
            0.9076277951380411+0.35183725320184833*1i
            0.9258900080115208+0.2649193558525325*1i
            0.9344546067381678+0.1810698911649172*1i
            0.9347405150932417+0.10016163091389042*1i
            0.927744680792082+0.02190283842290493*1i
            0.9141128489005637-0.054008939250351135*1i
            0.8942006869308787-0.1255715016785833*1i
            0.8696236801819268-0.19153998415990459*1i
            0.8411004396597874-0.252579816119938*1i
            0.8090306173701235-0.30919571382330996*1i
            0.7736404680425104-0.36180478289193174*1i
            0.7350407270697787-0.41071407716145897*1i
            0.6937642225114963-0.45550760954978603*1i
            0.6512781104103348-0.49550852797652556*1i
            0.6077553348825454-0.5312088409909421*1i
            0.5632204441314317-0.5629335302020955*1i
            0.5176501092854819-0.590918543250934*1i
            0.47100235929511497-0.6153153755971068*1i
            0.4234673392851724-0.6361221020807897*1i
            0.37629441630529803-0.6532663149079775*1i
            0.32959534928509604-0.6670269227958329*1i
            0.28329962957766397-0.6775774071173871*1i
            0.23733586610971694-0.6850288908053502*1i
            0.19164657718744685-0.6894394114034*1i
            0.14624650310116383-0.6908308820562555*1i
            0.10197688218677543-0.6894868917520581*1i
            0.05903685846870449-0.6856594412053696*1i
            0.01734253498058226-0.6794360027220846*1i
            -0.023173364396429714-0.6708637362535566*1i
            -0.06255415156065271-0.659958898005937*1i
            -0.10081488834527205-0.646716895299393*1i
            -0.1375366348927265-0.6314804758736645*1i
            -0.17246001139503703-0.6146223900323565*1i
            -0.2056643465919147-0.5961818653869656*1i
            -0.23720426456123203-0.5761745694315628*1i
            -0.26710860626831434-0.5546004001243406*1i
            -0.29537972291692177-0.5314517914911576*1i
            -0.3218752416503348-0.5069607758572251*1i
            -0.3464017104476354-0.48163977088750404*1i
            -0.3690223981755015-0.4555147436709925*1i
            -0.38978053688930003-0.42858478477467205*1i
            -0.4086951887690556-0.4008438354309108*1i
            -0.4257627478465033-0.37228728014071083*1i
            -0.44094770631024827-0.3430328037419764*1i
            -0.4542239980939713-0.31361734942085523*1i
            -0.46564433721119197-0.2840993618537282*1i
            -0.47524259208709246-0.2544679915791626*1i
            -0.4830317539642791-0.22471483828687747*1i
            -0.48900683156697095-0.1948388865546661*1i
            -0.4931568036076435-0.1648857292538703*1i
            -0.49560698193092195-0.13530140266434132*1i
            -0.49643971423865085-0.10619764044116407*1i
            -0.4956805387819444-0.07755694984449361*1i
            -0.49333833960470314-0.049369637335482816*1i
            -0.4894090562433107-0.02163714598751125*1i
            -0.4838814088517598+0.005622536815796165*1i
            -0.47694810883186844+0.03212083245599644*1i
            -0.4687714511153676+0.057706375845384045*1i
            -0.45936885915166525+0.08240105501095636*1i
            -0.44874583246037403+0.10621546796410586*1i
            -0.4369000071384642+0.12914710359360101*1i
            -0.42382528714872975+0.15117962129687976*1i
            -0.4096843183940509+0.17217857431492756*1i
            -0.39474942708227206+0.19200280294117814*1i
            -0.3790329980951086+0.21067557678151025*1i
            -0.3625372678791695+0.22820793375348958*1i
            -0.3452614718736538+0.24459736037995616*1i
            -0.32720561570489254+0.25982833977430897*1i
            -0.30847261886968214+0.2738515667507853*1i
            -0.2893966166594211+0.2866109463219935*1i
            -0.2700049417884307+0.2981277786991048*1i
            -0.2502965741188516+0.3084128355697203*1i
            -0.23027187970732088+0.31746422114477535*1i
            -0.2099357415837813+0.3252689571943514*1i
            -0.18934093983627565+0.3318090683763904*1i
            -0.1688064192161328+0.33713552266150526*1i
            -0.1483912348385353+0.3412846282687901*1i
            -0.12809126489530526+0.3442660138304755*1i
            -0.10790744741071454+0.34607863566086033*1i
            -0.08784805372322074+0.3467131276304777*1i
            -0.06793912104754372+0.3461574529622379*1i
            -0.04842034472410464+0.3445365781862478*1i
            -0.0293811354293112+0.3419332503111533*1i
            -0.010814667458957625+0.33835498164582767*1i
            0.007278069462670145+0.33380146953682216*1i
            0.024887000173638197+0.32826740599406334*1i
            0.04199246407526402+0.3217453437193745*1i
            ]';


%% Nicholson-Ross-Weir Algorithm

%Polar to Cartesian Form
freq_number = length(S11);
ur_list = zeros(freq_number,1);
er_list = zeros(freq_number,1);

for index = 1:freq_number
    %S11 = abs_S11(index).*(cos(arg_S11(index)) + 1i.*sin(arg_S11(index)));
    %S21 = abs_S21(index).*(cos(arg_S21(index)) + 1i.*sin(arg_S21(index)));
    
    %Auxillary Parameter
    X = (S11.^2 - S21.^2 + 1)./(2.*S11);

    %Reflection Coefficient from the Medium
    Gamma = X + sqrt(X.^2 - 1);

    %Phase Factor T/Transmission Coefficient
    T = (S11 + S21 - Gamma)./(1 - (S11 + S21).*Gamma);

    %Calculate the natural log of the inverse of T

    natlogT = log(1./T);

    %Calculation of 1/LAMBDA

    one_LAMBDA_sqrd = -((1/(2*pi*d)).*natlogT).^2;

    one_LAMBDA_sqrt = sqrt(one_LAMBDA_sqrd);

    % Ratio of (1 + Gamma)/(1 - Gamma)

    VSWR_material = (1 + Gamma)./(1 - Gamma);

    %Permeability Calculations

    ur = (one_LAMBDA_sqrt.*VSWR_material)./sqrt((1./(lambda_range).^2) -(1./(lambdac).^2))

    %Permittivity Calculations

    er = ((lambda_range.^2)./ur).*((1./(lambdac).^2)+one_LAMBDA_sqrd)
    
    ur_list = ur;
    er_list = er;

end
%S11 and S21
S11_real = real(S11);
S21_imag = real(S21);
S11_imag = imag(S11);
S21_imag = imag(S21);

%Permittivity
real_er = real(er_list);
imag_er = imag(er_list);
%Permeability
real_ur = real(ur_list);
imag_ur = imag(ur_list);

fig = figure('Color','w');

set(fig, 'Position', [1 41 1920 963]);
set(fig, 'Name', 'Artificial Permittivity');
set(fig, 'NumberTitle', 'off');

plot(freq_range/gigahertz, real_er,'-b','LineWidth', 3); hold on;
plot(freq_range/gigahertz, imag_er,'-r','LineWidth', 3); hold off;

axis([min(freq_range/gigahertz) max(freq_range/gigahertz) min(-50) max(50)]);
xlabel('Frequency (GHz)');
ylabel('\epsilon_r','Rotation',90);
title('Effective Relative Permittivity');
h = legend('f0','Location','NorthEastOutside');
set(h,'LineWidth',2);


